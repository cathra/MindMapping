<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>iOS的函数响应型编程 - 书栈(BookStack.CN)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../Styles/stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../Styles/page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre6">
    <h1 id="article-title" class="calibre11">添加FunctionalReactivePixels</h1>
    <div class="article-body" id="page-content">
        <div class="markdown-toc"><ul class="markdown-toc-list"><li class="calibre12"><a class="pcalibre1 calibre9 pcalibre" href="#添加FunctionalReactivePixels" level="1">添加FunctionalReactivePixels</a><ul class="calibre13"></ul></li>
</ul>
</div>
<h1 id="h1--functionalreactivepixels" class="calibre14"><a class="pcalibre1 calibre9 pcalibre" id="添加FunctionalReactivePixels"></a><span class="pcalibre2 header-link"></span>添加FunctionalReactivePixels</h1>
<p class="calibre15">一个简单的画廊弄好了，但是我们是不是想看一下高清图呢？当用户点击画廊中的某一个单元格时，我们创建一个新的视图控制器并将其推入到导航堆栈中。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">collectionView</span><span class="pun">:(</span><span class="typ">UICollectionView</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">collectionView</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    didSelectItemAtIndexPath</span><span class="pun">:(</span><span class="typ">NSIndexPath</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">indexPath</span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> viewController </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoModels</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photosArray currentPhotoIndex</span><span class="pun">:</span><span class="pln">indexPath</span><span class="pun">.</span><span class="pln">item</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    viewController</span><span class="pun">.</span><span class="kwd">delegate</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">navigationController pushViewController</span><span class="pun">:</span><span class="pln">viewController animated</span><span class="pun">:</span><span class="pln">YES</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">这个方法没有任何特殊的，只是些一般的OC方法。当然别忘了在当前实现文件里加载视图控制器(FRPFullSizePhotoViewControler)的头文件.现在让我们来创建这个视图控制器(FRPFullSizePhotoViewControler).</p>
<p class="calibre15">创建一个UIViewController的子类FRPFullSizePhotoViewControler,这不会是一个特别的‘Reactive’的视图控制器，实际上大部分只是<code class="calibre20 pcalibre6 pcalibre5">UIPageViewController</code>子视图控制器的模版。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@class</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewController</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@protocol</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewControllerDelegate</span><span class="pln"> </span><span class="pun">&lt;</span><span class="typ">NSOject</span><span class="pun">&gt;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">userDidScroll</span><span class="pun">:(</span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">viewController toPhotoAtIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">index</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="typ">UIViewController</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithPhotoModels</span><span class="pun">:(</span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModelArray currentPhotoIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">photoIndex</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic </span><span class="pun">,</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pun">)</span><span class="pln"> </span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModelArray</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> weak</span><span class="pun">)</span><span class="pln"> id</span><span class="pun">&lt;</span><span class="typ">FRPFullSizePhotoViewControllerDelegate</span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">delegate</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">回到画廊视图控制器实现必要的代理方法：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">userDidScroll</span><span class="pun">:(</span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">viewController toPhotoAtIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">index</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">collectionView scrollToItemAtIndexPath</span><span class="pun">:[</span><span class="typ">NSIndexPath</span><span class="pln"> indexPathForItem</span><span class="pun">:</span><span class="pln">index inSection</span><span class="pun">:</span><span class="lit">0</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                atScrollPosition</span><span class="pun">:</span><span class="typ">UICollectionViewScrollPositionCenteredVertically</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                        animated</span><span class="pun">:</span><span class="pln">NO</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">当我们滑到一个新的图像去查看其高清图片时，这个方法将更新collectionView滑动的位置。这样一来，当用户查看完高清图回到这个界面的时候，高清图所对应的缩略图将会显示在界面上，方便用户获知自己浏览的位置以及继续往下浏览。</p>
<p class="calibre15"><code class="calibre20 pcalibre6 pcalibre5">#import</code>这些必要的数据模型的头文件并追加一下两个私有属性：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> </span><span class="pun">()</span><span class="pln"> </span><span class="pun">&lt;</span><span class="typ">UIPageViewControllerDataSource</span><span class="pun">,</span><span class="pln"> </span><span class="typ">UIPageViewControllerDelegate</span><span class="pun">&gt;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Private assignment</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> strong</span><span class="pun">)</span><span class="pln"> </span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModeArray</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Private properties</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> strong</span><span class="pun">)</span><span class="pln"> </span><span class="typ">UIPageViewController</span><span class="pln"> </span><span class="pun">*</span><span class="pln">pageViewController</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15"><code class="calibre20 pcalibre6 pcalibre5">photoModelArray</code>是共有的只读属性，但是内部可读写。第二个属性是我们的子视图控制器。我们这样来初始化：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithPhotoModels</span><span class="pun">:(</span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModelArray currentPhotoIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">photoIndex</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//Initialized, read-only properties</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModelArray </span><span class="pun">=</span><span class="pln"> photoModelArray</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//Configure self</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">title </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModelArray</span><span class="pun">[</span><span class="pln">photoIndex</span><span class="pun">]</span><span class="pln"> photoName</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//ViewControllers</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIPageViewController</span><span class="pln"> alloc</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    initWithTransitionStyle</span><span class="pun">:</span><span class="typ">UIPageViewControlerTransitionStyleScroll</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    navigationOrientation</span><span class="pun">:</span><span class="typ">UIPageViewControllerNavigationOrientationHorizontal</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    options</span><span class="pun">:@{</span><span class="pln"> </span><span class="typ">UIPageViewControllerInterPageSpacingKey</span><span class="pun">:</span><span class="pln"> </span><span class="pun">@(</span><span class="lit">30</span><span class="pun">)};</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">.</span><span class="pln">dataSource </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">.</span><span class="kwd">delegate</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> addchildViewController</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController setViewController</span><span class="pun">:@[[</span><span class="kwd">self</span><span class="pln"> photoViewControllerForIndex</span><span class="pun">:</span><span class="pln">photoIndex</span><span class="pun">]]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            direction</span><span class="pun">:</span><span class="typ">UIPageViewControllerNavigationDirectionForward</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            animated</span><span class="pun">:</span><span class="pln">NO completion</span><span class="pun">:</span><span class="kwd">nil</span><span class="pln"> </span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">赋值属性、设置标题、配置我们的<code class="calibre20 pcalibre6 pcalibre5">pageViewController</code>，一切都非常无聊，我们的viewDidLoad方法也同样简单。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">viewDidLoad</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> viewDidLoad</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">view</span><span class="pun">,</span><span class="pln">backGroundColor </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIColor</span><span class="pln"> blackColor</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="pln">frame </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="pln">bounds</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">view addSubView</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">.</span><span class="pln">view</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">我要指出的是，简便起见，在我的应用里我禁用了横向展示，因为这不是一本关于<code class="calibre20 pcalibre6 pcalibre5">autoresizingMask</code>或者<code class="calibre20 pcalibre6 pcalibre5">autoLayout</code>的书。你可以通过<a href="http://www.amazon.com/Layout-Demystified-Edition-Mobile-Programming/dp/0321967194" class="pcalibre1 calibre9 pcalibre">Eria Sadun的书</a>了解更多关于<code class="calibre20 pcalibre6 pcalibre5">autoLayout</code>方面的细节。</p>
<p class="calibre15">下面我们来了解一下UIPageViewController的数据源协议和代理协议。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">pageViewController</span><span class="pun">:(</span><span class="typ">UIPageViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">pageViewController</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    didFinishAnimating</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">BOOL</span><span class="pun">)</span><span class="pln">finished</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    previousViewControllers</span><span class="pun">:(</span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">previousViewControllers</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    transitionCompleted</span><span class="pun">:(</span><span class="pln">BOOL</span><span class="pun">)</span><span class="pln">completed</span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">title </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">.</span><span class="pln">viewControllers</span><span class="pun">.</span><span class="pln">firstObject photoModel</span><span class="pun">]</span><span class="pln"> photoName</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="kwd">delegate</span><span class="pln"> userDidScroll</span><span class="pun">:</span><span class="kwd">self</span><span class="pln"> toPhotoAtIndex</span><span class="pun">:[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">pageViewController</span><span class="pun">.</span><span class="pln">viewControllers</span><span class="pun">.</span><span class="pln">firstObject photoIndex</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">UIViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">pageViewController</span><span class="pun">:(</span><span class="typ">UIPageViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">pageViewController viewControllerBeforeViewController</span><span class="pun">:(</span><span class="typ">FRPPhotoViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">viewController</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> photoViewControllerForIndex</span><span class="pun">:</span><span class="pln">viewController</span><span class="pun">.</span><span class="pln">photoIndex </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">UIViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">pageViewController</span><span class="pun">:(</span><span class="typ">UIPageViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">pageViewController viewControllerAfterViewController</span><span class="pun">:(</span><span class="typ">FRPPhotoViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">viewController </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> photoViewControllerForIndex</span><span class="pun">:</span><span class="pln">viewController</span><span class="pun">.</span><span class="pln">photoIndex </span><span class="pun">+</span><span class="pln"> </span><span class="lit">1</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">虽然这些方法没有技术上的<code class="calibre20 pcalibre6 pcalibre5">reactive</code>，却体现出一定意义上的实用性。我很佩服这种在特殊类型的视图控制器上的抽像，干得漂亮，Apple！</p>
<p class="calibre15">我们的视图控制器创建方法，类似下面这样：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FRPPhotoViewController</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoViewControllerForIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">index</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">index </span><span class="pun">&gt;=</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> index </span><span class="pun">&lt;</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModelArray</span><span class="pun">.</span><span class="pln">count</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModel </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModelArray</span><span class="pun">[</span><span class="pln">index</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">FRPPhotoViewController</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoViewController </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoViewController</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoModel</span><span class="pun">:</span><span class="pln">photoModel index</span><span class="pun">:</span><span class="pln">index</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> photoViewController</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//Index was out of bounds, return nil</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln"> </span><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">它基本上创建比配置了一个我们将要使用的UIViewController的子视图控制器FRPPhotoViewController。下面是他的头文件：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@class</span><span class="pln"> </span><span class="typ">FRPPhotoModel</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPPhotoViewController</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="typ">UIViewController</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel index</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">photoIndex</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pun">)</span><span class="pln"> </span><span class="typ">NSInteger</span><span class="pln"> photoIndex</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">readonly</span><span class="pun">)</span><span class="pln"> </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> photoModel</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">这个视图控制器非常简单：显示一个photoModel下的高清图片，并提示photoImporter(单例对象)下载这个图片。它是如此简单，我现在就告诉你它的全部实现。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Model</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPPhotoModel.h"</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Utilities</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPPhotoImporter.h"</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;SVProgressHUD.h&gt;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPPhotoViewController</span><span class="pln"> </span><span class="pun">()</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Private assignment</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> assign</span><span class="pun">)</span><span class="pln"> </span><span class="typ">NSInteger</span><span class="pln"> photoIndex</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> strong</span><span class="pun">)</span><span class="pln"> </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModel</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Private properties</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> weak</span><span class="pun">)</span><span class="pln"> </span><span class="typ">UIImageView</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> imageView</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@implementation</span><span class="pln"> </span><span class="typ">FRPPhotoViewController</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel index</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">photoIndex</span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModel </span><span class="pun">=</span><span class="pln"> photoModel</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoIndex </span><span class="pun">=</span><span class="pln"> photoIndex</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">viewDidLoad</span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> viewDidLoad</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//Configure self's view</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="pln">backGroundColor </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIColor</span><span class="pln"> blackColor</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//Configure subViews</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">UIImageView</span><span class="pln"> </span><span class="pun">*</span><span class="pln">imageView </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">UIImageView</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithFrame</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">view</span><span class="pun">.</span><span class="pln">bounds</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="pln">imageView</span><span class="pun">,</span><span class="pln"> image</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">RACObserve</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModel</span><span class="pun">,</span><span class="pln"> fullsizeData</span><span class="pun">)</span><span class="pln"> map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="pln">id value</span><span class="pun">){</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIImage</span><span class="pln"> imageWithData</span><span class="pun">:</span><span class="pln">value</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    imageView</span><span class="pun">.</span><span class="pln">contentMode </span><span class="pun">=</span><span class="pln"> </span><span class="typ">UIViewContentModeScaleAspectFit</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">view addSubView</span><span class="pun">:</span><span class="pln">imageView</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">imageView </span><span class="pun">=</span><span class="pln"> imageView</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">viewWillAppear</span><span class="pun">:(</span><span class="pln">BOOL</span><span class="pun">)</span><span class="pln">animated</span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> viewWillAppear</span><span class="pun">:</span><span class="pln">animated</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="typ">SVProgressHUD</span><span class="pln"> show</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="com">//Fetch data</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> fetchPhotoDetails</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModel</span><span class="pun">]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            subscribeError</span><span class="pun">:^(</span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="typ">SVProgressHUD</span><span class="pln"> showErrorWithStatus</span><span class="pun">:@</span><span class="str">"Error"</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            completed</span><span class="pun">:^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="typ">SVProgressHUD</span><span class="pln"> dismiss</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">就像我们的collectionViewCell中那样，我们将UIImageView的image属性和数据模型的某个属性映射后的值绑定，所不同的是ViewController不需要考虑复用，所以我们不必计较怎么取消imageView的订阅—-当imageView对象解除分配的时候，订阅将会被取消。</p>
<p class="calibre15">这个实现里面另一个有趣的部分在<code class="calibre20 pcalibre6 pcalibre5">viewWillAppear:</code>里：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">[</span><span class="typ">SVProgressHUD</span><span class="pln"> show</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Fetch data</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> fetchPhotoDetails</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photoModel</span><span class="pun">]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        subscribeError</span><span class="pun">:^(</span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> error</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">[</span><span class="typ">SVProgressHUD</span><span class="pln"> showErrorWithStatus</span><span class="pun">:@</span><span class="str">"Error"</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        completed</span><span class="pun">:^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">[</span><span class="typ">SVProgressHUD</span><span class="pln"> dismiss</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}];</span></code></li>
</ol></pre>
<p class="calibre15">没有收到错误或者完成信息之前，我们必须给用户展示网络请求的状态。你看，500px的受欢迎的照片的API接口只返回了一个照片的大概信息，但我们需要这个照片更详细的信息，所以我们必须调用第二个API接口来获取每一个照片的详细信息（包括全尺寸照片的URL）。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoURLRequest</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">AppDelegate</span><span class="pun">.</span><span class="pln">apiHelper urlRequestForPhotoID</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">identifier</span><span class="pun">.</span><span class="pln">integerValue</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">我们还没有实现<code class="calibre20 pcalibre6 pcalibre5">fetchPhotoDetails:</code>方法，所以现在我们回到<code class="calibre20 pcalibre6 pcalibre5">FRPPhotoImporter</code>中，在头文件中定义这个方法，在实现文件中实现它。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACReplaySubject</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">fetchPhotoDetails</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">RACReplaySubject</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> subject </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">RACReplaySubject</span><span class="pln"> subject</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> photoURLRequest</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="typ">NSURLConnection</span><span class="pln"> sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        queue</span><span class="pun">:[</span><span class="typ">NSOperationQueue</span><span class="pln"> mainQueue</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        completionHandler</span><span class="pun">:^</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSURLResponse</span><span class="pln"> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">connectionError</span><span class="pun">){</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">data</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                id results </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSJSONSerialization</span><span class="pln"> </span><span class="typ">JSONObjectWithData</span><span class="pun">:</span><span class="pln">data options</span><span class="pun">:</span><span class="lit">0</span><span class="pln"> error</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">][</span><span class="pln"> </span><span class="pun">@</span><span class="str">"photo"</span><span class="pln"> </span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> configurePhotoModel</span><span class="pun">:</span><span class="pln">photoModel withDictionary</span><span class="pun">:</span><span class="pln">results</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> downloadFullsizedImageForPhotoModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="pln">subject sendNext</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="pln">subject sendCompleted</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="kwd">else</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="pln">subject sendError</span><span class="pun">:</span><span class="pln">connectionError</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> subject</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">这种方法跟前面我们看到的<code class="calibre20 pcalibre6 pcalibre5">importPhotos</code>方法模式一样，我们的<code class="calibre20 pcalibre6 pcalibre5">downloadFullsizedImageForPhotoModel:</code>方法跟<code class="calibre20 pcalibre6 pcalibre5">downloadThumbnailForPhotoModel:</code>方法也是一样的。除了这两者之外，还有什么重要的抽象方法呢？让我们来完成我们的缩略图方法。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadThumbnailForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">thumbnailURL withCompletion</span><span class="pun">:^(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        photoModel</span><span class="pun">.</span><span class="pln">thumbnailData </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadFullsizedImageForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">fullsizedURL withCompletion</span><span class="pun">:^(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> data</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        photoModel</span><span class="pun">.</span><span class="pln">fullsizedData </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadFullsizedImageForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">fullsizedURL withCompletion</span><span class="pun">:^(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        photoModel</span><span class="pun">.</span><span class="pln">fullsizedData </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">download</span><span class="pun">:(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">urlString withCompletion</span><span class="pun">:(</span><span class="kwd">void</span><span class="pun">(^)(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> data</span><span class="pun">))</span><span class="pln">completion</span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">urlString</span><span class="pun">,</span><span class="pln"> </span><span class="pun">@</span><span class="str">"URL must not be nil"</span><span class="pln"> </span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSURLRequest</span><span class="pln"> requestWithURL</span><span class="pun">:[</span><span class="pln">NSURL </span><span class="typ">URLWithString</span><span class="pun">:</span><span class="pln">urlString</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="typ">NSURLConnnection</span><span class="pln"> sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request queue</span><span class="pun">:[</span><span class="typ">NSOperationQueue</span><span class="pln"> mainQueue</span><span class="pun">]</span><span class="pln"> completionHandler</span><span class="pun">:^(</span><span class="typ">NSURLResponse</span><span class="pln"> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">connectionError</span><span class="pun">){</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">completion</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            completion</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">我曾经与这样一位客户工作过，他认为如果你某行一样的代码重复写两次，这代码就应该得到某种程度的抽象。虽然我认为这有点偏激，但我喜欢这种态度。</p>
<p class="calibre15">好了。我们现在可以运行这个应用，点击一个图片去查看它的高清图片。我们也可以向前或者向后滑动来查看前一个或后一个高清图片。非常棒！</p>
<p class="calibre15"><img src="../Images/6032259d965bbf063dbd17ee627159c2.png" alt="fullsize_gallerypictures" class="calibre22"/></p>

    </div>
</body>
</html>