<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>iOS的函数响应型编程 - 书栈(BookStack.CN)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../Styles/stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../Styles/page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre6">
    <h1 id="article-title" class="calibre11">测试ViewModels</h1>
    <div class="article-body" id="page-content">
        <div class="markdown-toc"><ul class="markdown-toc-list"><li class="calibre12"><a class="pcalibre1 calibre9 pcalibre" href="#测试ViewModels" level="1">测试ViewModels</a><ul class="calibre13"></ul></li>
</ul>
</div>
<h1 id="h1--viewmodels" class="calibre14"><a class="pcalibre1 calibre9 pcalibre" id="测试ViewModels"></a><span class="pcalibre2 header-link"></span>测试ViewModels</h1>
<p class="calibre15">&#160;&#160;本书的最后一节，我们谈谈测试，尤其是单元测试。在iOS的开发社区里，这是一个有争议的话题，这也是为什么我要把它放在最后的原因。理想的情况下。你应该在编写视图模型的同时为它编写单元测试。然而学习如何使用这种新的模式来编码已经很困难，尝试去测试这些你没有吃透的东西，多你来说压力太大，所以我把它放在了最后（学到这里我相信你已经理解了这种编码方式）。</p>
<p class="calibre15">&#160;&#160;当然我也注意到，并不是每个人都以相同的方式来测试，或者能够测试到相同的程度。我有.Net编程背景，在.net中使用mocks来测试系统的实现细节是最平常不过的了。其他平台背景的开发者较少使用mocks来做，甚至从来没有这样的经验。本节我只将我的单元测试方法分享给大家，如果你觉得合适就采用。</p>
<p class="calibre15">&#160;&#160;确保你的<code class="calibre20 pcalibre6 pcalibre5">Podfile</code>文件包含下面这些库：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">target </span><span class="str">"FRPTests"</span><span class="pln"> </span><span class="kwd">do</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'ReactiveCocoa'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'2.1.4'</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'ReactiveViewModel'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'0.1.1'</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'libextobjc'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'0.3'</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'500px-iOS-api'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'1.0.5'</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'Specta'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'~&gt; 0.2.1'</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'Expecta'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'~&gt; 0.2'</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">pod </span><span class="str">'OCMock'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'~&gt; 2.2.2'</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="kwd">end</span></code></li>
</ol></pre>
<p class="calibre15">&#160;&#160;然后运行<code class="calibre20 pcalibre6 pcalibre5">pod install</code>.</p>
<p class="calibre15">&#160;&#160;首先我们来看看<code class="calibre20 pcalibre6 pcalibre5">FRPFullSizePhotoViewModel</code>，因为它最具Objective-C风范(没有太多ReactiveCocoa).</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> </span><span class="pun">()</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">//Private access</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> assign</span><span class="pun">)</span><span class="pln"> </span><span class="typ">NSInteger</span><span class="pln"> initialPhotoIndex</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@implementation</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewModel</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithPhotoArray</span><span class="pun">:(</span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoArray initialPhotoIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">initialPhotoIndex </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="pln">photoArray</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">initialPhotoIndex </span><span class="pun">=</span><span class="pln"> initialPhotoIndex</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">initialPhotoName </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">initialPhotoIndex</span><span class="pun">]</span><span class="pln"> photoName</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModelAtIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">index </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">index </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> index </span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">.</span><span class="pln">count </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="com">//Index was out of bounds, return nil</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">[</span><span class="pln">index</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">好了，我们先来测试这个初始化方法，然后在转移到其他两个方法上。</p>
<p class="calibre15">我们想印证初始化我们的视图模型时，它的两个属性<code class="calibre20 pcalibre6 pcalibre5">model</code>和<code class="calibre20 pcalibre6 pcalibre5">initialPhotoIndex</code>被正确地赋值了。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;Specta/Specta.h&gt;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#define</span><span class="pln"> EXP_SHORTHAND</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;Expecta/Expecta.h&gt;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;OCMock/OCMock.h&gt;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPPhotoModel.h"</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPFullSizePhotoViewModel.h"</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">SpecBegin</span><span class="pun">(</span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pun">)</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">describe</span><span class="pun">(@</span><span class="str">"FRPFullSizePhotoModel"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    it </span><span class="pun">(@</span><span class="str">"Should assign correct attributes when initialized"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*</span><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@[];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">NSInteger</span><span class="pln"> initialPhotoIndex </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1337</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln">\</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">         </span><span class="pun">[[</span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoArray</span><span class="pun">:</span><span class="pln">model</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                                     initialPhotoIndex</span><span class="pun">:</span><span class="pln"> initialPhotoIndex</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        expect</span><span class="pun">(</span><span class="pln">model</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">viewModel</span><span class="pun">.</span><span class="pln">model</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        expect</span><span class="pun">(</span><span class="pln">initialPhotoIndex</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">viewModel</span><span class="pun">.</span><span class="pln">initialPhotoIndex</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">});</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">SpecEnd</span></code></li>
</ol></pre>
<p class="calibre15">&#160;&#160;在该代码段顶部，我们导入了一些头文件，包括一个奇怪的预定义<code class="calibre20 pcalibre6 pcalibre5">EXP_SHORTHAND</code>,我们把他放在那里以便于可以使用类似<code class="calibre20 pcalibre6 pcalibre5">expect()</code>这样的shorthand matchers（速记匹配）的语法。然后我们引入我们的私有接口<code class="calibre20 pcalibre6 pcalibre5">SpecBegin(...)/SpecEnd</code>来为我们正在测试的视图模型屏蔽编译警告，最后的部分就是我们的单元测试本身。<code class="calibre20 pcalibre6 pcalibre5">Specta</code>的测试规范相当简单，你可以阅读更多的关于这方面的信息，但本书不会深入讲解它的一些细节。总之你的测试始于<code class="calibre20 pcalibre6 pcalibre5">SpecBegin</code>并终止于<code class="calibre20 pcalibre6 pcalibre5">SpecEnd</code>，测试例程用类似于<code class="calibre20 pcalibre6 pcalibre5">@"应该。。。",^{ 预测正常的情况应该如何 }</code>写在中间。</p>
<p class="calibre15">&#160;&#160;好了，停止模拟器中正在运行的应用，按下<code class="calibre20 pcalibre6 pcalibre5">cmd+U</code>快捷键，你就可以运行这段单元测试了。如果一切正常，你就能通过测试。</p>
<p class="calibre15">接下来我们来看看<code class="calibre20 pcalibre6 pcalibre5">photoModelAtIndex:</code>方法</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModelAtIndex</span><span class="pun">:(</span><span class="typ">NSInteger</span><span class="pun">)</span><span class="pln">index </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">index </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> index </span><span class="pun">&gt;</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">.</span><span class="pln">count </span><span class="pun">-</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="com">// Index was out of bounds ,return nil</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">[</span><span class="pln"> index </span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">这里面没有太多的业务逻辑，但是我们看到其他地方都要使用它，所以我们的测试应该是健壮的。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it</span><span class="pun">(@</span><span class="str">"Should return nil for an out-of-bounds photo index"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*</span><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@[[</span><span class="typ">NSobject</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSInteger</span><span class="pln"> initialPhotoIndex </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> \</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[</span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoArray</span><span class="pun">:</span><span class="pln">model initialPhotoIndex</span><span class="pun">:</span><span class="pln">initialPhotoIndex</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id subzeroModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">viewModel photoModelAtIndex</span><span class="pun">:-</span><span class="lit">1</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    expect</span><span class="pun">(</span><span class="pln">subzeroModel</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">beNil</span><span class="pun">();</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id aboveBoundsModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">viewModel photoModelAtIndex</span><span class="pun">:</span><span class="pln">model</span><span class="pun">.</span><span class="pln">count</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    expect</span><span class="pun">(</span><span class="pln">aboveBoundsModel</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">beNil</span><span class="pun">();</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it</span><span class="pun">(@</span><span class="str">"Should return the correct model for photoModelAtIndex:"</span><span class="pun">,^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id photoModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSObject</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*</span><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@[</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSInteger</span><span class="pln"> initialPhotoIndex </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> \</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[</span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoArray</span><span class="pun">:</span><span class="pln">model initialPhotoIndex</span><span class="pun">:</span><span class="pln">initialPhotoIndex</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id returnModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">viewModel photoModelAtIndex</span><span class="pun">:</span><span class="lit">0</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    expect</span><span class="pun">(</span><span class="pln">returnModel</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">photoModel</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
</ol></pre>
<p class="calibre15">太棒了！我们这个新的测试保证了我们的代码具有完全的代码覆盖率。它检测了<code class="calibre20 pcalibre6 pcalibre5">photoModelAtIndex:</code>参数的三种可能的情况：少于0、在作用范围内以及越界。</p>
<p class="calibre15">最后，我们来看下<code class="calibre20 pcalibre6 pcalibre5">initialPhotoName</code>方法：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">initialPhotoName </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">initialPhotoIndex</span><span class="pun">]</span><span class="pln"> photoName</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">方法看起来很简单，但实际上这里面包含了更深层级的东西。恰当地重构一些代码并为它写一点不一样的更小的测试代码，来严格地测试这个方法。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">initialPhotoName </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> initialPhotoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="pln">photoModel photoName</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">initialPhotoModel </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> photoModelAtIndex</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">initialPhotoIndex</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">这更清晰简单了，一个方法确切地只做一件事情，就像一棵树的树皮，层层叠叠相互依存。只要我们一路下来所有的代码都测试，那么最后我们就可以很确切地保证代码的健壮性。</p>
<p class="calibre15"><code class="calibre20 pcalibre6 pcalibre5">initialPhotoModel</code>是一个私有方法，所以测试它我们需要在测试文件中申明它。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> </span><span class="pun">()</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">initialPhotoModel</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">你看到的所有我们的测试代码都非常简单。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it </span><span class="pun">(@</span><span class="str">"Should return the correct initial photo model"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSArray</span><span class="pln"> </span><span class="pun">*</span><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@[[</span><span class="typ">NSobject</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSInteger</span><span class="pln"> initialPhotoIndex </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> \</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[</span><span class="typ">FRPFullSizePhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoArray</span><span class="pun">:</span><span class="pln">model initialPhotoIndex</span><span class="pun">:</span><span class="pln">initialPhotoIndex</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id mockViewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> partialMockForObject</span><span class="pun">:</span><span class="pln">viewModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[[</span><span class="pln">mockViewModel expect</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:</span><span class="pln">model</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]]</span><span class="pln"> photoModelAtIndex</span><span class="pun">:</span><span class="pln">initialPhotoIndex</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id returnedObject </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">mockViewModel initialPhotoModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    expect</span><span class="pun">(</span><span class="pln">returnedObject</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">model</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="pln">mockViewModel verify</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
</ol></pre>
<p class="calibre15">这个测试是用来确认当<code class="calibre20 pcalibre6 pcalibre5">initialPhotoModel</code>被调用时，接下来它应该调用<code class="calibre20 pcalibre6 pcalibre5">photoModelAtIndex:</code>方法并将<code class="calibre20 pcalibre6 pcalibre5">initialPhotoIndex</code>作为参数传入。这个测试是否简单取决于我们测试<code class="calibre20 pcalibre6 pcalibre5">photoModelAtIndex:</code>是否充分。</p>
<p class="calibre15">接下来，就让我们一起来看看<code class="calibre20 pcalibre6 pcalibre5">FRPGalleryViewModel</code>,这看似非常简单：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">init </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> model</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> importPhotos</span><span class="pun">]</span><span class="pln"> logError</span><span class="pun">]</span><span class="pln"> catchTo</span><span class="pun">:[</span><span class="typ">RACSignal</span><span class="pln"> empty</span><span class="pun">]];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">然而，它可测性不高，需要重构。</p>
<p class="calibre15">我们简单地重构下视图模型。新的实现如下：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@implementation</span><span class="pln"> </span><span class="typ">FRPGalleryViewModel</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">init </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> model</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> importPhotosSignal</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">importPhotosSignal </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> importPhotos</span><span class="pun">]</span><span class="pln"> logError</span><span class="pun">]</span><span class="pln"> catchTo</span><span class="pun">:[</span><span class="typ">RACSignal</span><span class="pln"> empty</span><span class="pun">]];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">我们把<code class="calibre20 pcalibre6 pcalibre5">importPhotos</code>的调用抽出来，以方便测试这个方法是否被调用。我们不会测试<code class="calibre20 pcalibre6 pcalibre5">FRPPhotoImporter</code>，关于它的测试(即单例测试)已经超出了本书的范畴。</p>
<p class="calibre15">这部分的测试代码如下：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "Specta.h"</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;OCMock/OCMock.h&gt;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPGalleryViewModel.h"</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPGalleryViewModel</span><span class="pln"> </span><span class="pun">()</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">importPhotosSignal</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">SpecBegin</span><span class="pun">(</span><span class="typ">FRPGalleryViewModel</span><span class="pun">)</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">describe</span><span class="pun">(@</span><span class="str">"FRPGalleryViewModel"</span><span class="pun">,^{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    it</span><span class="pun">(@</span><span class="str">"should be initialized and call importPhotos"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        id mockObject </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> mockForClass</span><span class="pun">:[</span><span class="typ">FRPGalleryViewModel</span><span class="pln"> </span><span class="kwd">class</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[[</span><span class="pln">mockObject expect</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:[</span><span class="typ">RACSignal</span><span class="pln"> empty</span><span class="pun">]]</span><span class="pln"> importPhotosSignal</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        mockObject </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">mockObject init</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[</span><span class="pln">mockObject verify</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[</span><span class="pln">mockObject stopMocking</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">});</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
</ol></pre>
<p class="calibre15">&#160;&#160;为了测试一个方法，测试代码也太多了吧！ 我知道，我知道~ 这是OCMock没落的原因之一，它竟然需要这么多的模板。但你不能责怪它，因为它要工作在令它不寒而栗的Objective-C平台上！</p>
<p class="calibre15">&#160;&#160;我们创建了一个<code class="calibre20 pcalibre6 pcalibre5">FRPGalleryViewModel</code>的mock版本，告诉它期望<code class="calibre20 pcalibre6 pcalibre5">importPhotoSignal</code>被调用。然后才进行对象的初始化。这里使用了一点点技巧，因为我们在mockObject上调用了init方法，但它(init)实际上是一个NSProxy的子类。然后，对OCMock来讲，它足够聪明，它了解这一切，有能力做出正确的选择。只是看起来有点诡异罢了。我们使用<code class="calibre20 pcalibre6 pcalibre5">[mockObject init]</code>给<code class="calibre20 pcalibre6 pcalibre5">mockObject</code>赋值，也是为了屏蔽编译警告。最后我们验证了所有预期可能被调用的方法。</p>
<p class="calibre15">&#160;&#160;这个例子中表现出来的测试很困难的情况也说明了另一个问题，你应该避免视图模型的初始化方法产生”副作用”(参见前面章节提到的“函数的副作用”)，应该使用<code class="calibre20 pcalibre6 pcalibre5">didBecomeActiveSignal</code>来代理。</p>
<p class="calibre15">下面我们来测试<code class="calibre20 pcalibre6 pcalibre5">FRPPhotoViewModel</code>.再次突出引起函数副作用和使用<code class="calibre20 pcalibre6 pcalibre5">didBecomeActiveSignal</code>的区别。</p>
<p class="calibre15">快速浏览下实现：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@implementation</span><span class="pln"> </span><span class="typ">FRPPhotoViewModel</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">intancetype</span><span class="pun">)</span><span class="pln">initWithModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="lit">@weakify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">didBecomeActiveSignal subscribeNext</span><span class="pun">:^</span><span class="pln"> </span><span class="pun">(</span><span class="pln">id x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="lit">@strongify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">loading </span><span class="pun">=</span><span class="pln"> YES</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> fetchPhotoDetails</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            subscribeError</span><span class="pun">:</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="typ">NSLog</span><span class="pun">(@</span><span class="str">"Could not fetch photo details: %@"</span><span class="pun">,</span><span class="pln">error</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            completed</span><span class="pun">:</span><span class="pln"> </span><span class="pun">^</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">loading </span><span class="pun">=</span><span class="pln"> NO</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="typ">NSLog</span><span class="pun">(@</span><span class="str">"Fetched photo details"</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> photoImage</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">RACObserve</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> fullsizedData</span><span class="pun">)</span><span class="pln"> map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="pln">id value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIImage</span><span class="pln"> imageWithData</span><span class="pun">:</span><span class="pln">value</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoName </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">.</span><span class="pln">photoName</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">首先我们来测试<code class="calibre20 pcalibre6 pcalibre5">photoName</code>方法：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;Specta/Specta.h&gt;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#define</span><span class="pln"> EXP_SHORTHAND</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;Expecta/Expecta.h&gt;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import &lt;OCMock/OCMock.h&gt;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPPhotoViewModel.h"</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="com">#import "FRPPhotoModel.h"</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">SpecBegin</span><span class="pun">(</span><span class="typ">FRPPhotoViewModel</span><span class="pun">)</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">describe </span><span class="pun">(@</span><span class="str">"FRPPhotoViewModel"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    it</span><span class="pun">(@</span><span class="str">"should return the photo's name property when photoName is invoked"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*</span><span class="pln">name </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@</span><span class="str">"Ash"</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        id mockPhotoModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> mockForClass</span><span class="pun">:[</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="kwd">class</span><span class="pun">]];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[[</span><span class="pln">mockPhotoModel stub</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:</span><span class="pln">name</span><span class="pun">]</span><span class="pln"> photoName</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">FRPPhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        id mockViewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> partialMockForObject</span><span class="pun">:</span><span class="pln">viewModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[[[</span><span class="pln">mockViewModel stub</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:</span><span class="pln">mockPhotoModel</span><span class="pun">]</span><span class="pln"> model</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        id returnName </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">mockViewModel photoName</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        expect</span><span class="pun">(</span><span class="pln">returnedName</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">name</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[</span><span class="pln">mockPhotoModel stopMocking</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">});</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
</ol></pre>
<p class="calibre15">我们为mock的视图模型的model属性添加了一个mockPhotoModel，它会mocks所有的途径。</p>
<p class="calibre15">现在来看这个复杂的初始化方法，这东西看起来真巨大！近20行纯粹的未经测试的代码。哎呀！让我们来一点点简化这个事情，并逐步加上我们的测试代码。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">if</span><span class="pun">(!</span><span class="kwd">self</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="lit">@weakify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">didBecomeActiveSignal subscribeNext</span><span class="pun">:^(</span><span class="pln">id x</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="lit">@strongify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> downloadPhotoModelDetails</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> photoImage</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">RACObserve</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">,</span><span class="pln"> fullsizedData</span><span class="pun">)</span><span class="pln"> map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="pln">id value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIImage</span><span class="pln"> imageWithData</span><span class="pun">:</span><span class="pln">value</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadPhotoModelDetails </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">loading </span><span class="pun">=</span><span class="pln"> YES</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> fetchPhotoDetails</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">model</span><span class="pun">]</span><span class="pln"> subscribeError</span><span class="pun">:^(</span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">NSLog</span><span class="pun">(@</span><span class="str">"Could not fetch photo details : %@"</span><span class="pun">,</span><span class="pln">error</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}</span><span class="pln"> completed</span><span class="pun">:^</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">loading </span><span class="pun">=</span><span class="pln"> NO</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="typ">NSLog</span><span class="pun">(@</span><span class="str">"Fetched photo details."</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">我们选择了不直接测试<code class="calibre20 pcalibre6 pcalibre5">fetchPhotoDetails:</code>,所以我们把它置于一个实例方法中，以便更容易对它进行测试。这个方法(即<code class="calibre20 pcalibre6 pcalibre5">fetchPhotoDetails:</code>)实现的细节在这里对我们不重要。</p>
<p class="calibre15">现在开始写关于它的测试代码吧：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it</span><span class="pun">(@</span><span class="str">"should download photo model details when it becomes active"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPPhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id mockViewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> partialMockForObject</span><span class="pun">:</span><span class="pln">viewModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[</span><span class="pln">mockViewModel expect</span><span class="pun">]</span><span class="pln"> downloadPhotoModelDetails</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="pln">mockViewModel setActive</span><span class="pun">:</span><span class="pln">YES</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="pln">mockViewModel verify</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
</ol></pre>
<p class="calibre15">注意看初始化方法中不产生(函数)副作用而是把这种副作用放在订阅<code class="calibre20 pcalibre6 pcalibre5">didBecomeActiveSignal</code>的Block块中时，测试视图模型的代码是多么简单！</p>
<p class="calibre15">现在我们需要测试剩下的那些视图模型，他们全部非常简单。我们使用更少的mock，因为很多的业务逻辑仅仅是视图模型的model值到他自己的属性的映射。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it </span><span class="pun">(@</span><span class="str">"should return the photo's name property when photoName is invoked"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*</span><span class="pln">name </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@</span><span class="str">"Ash"</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id mockPhotoModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> mockForClass</span><span class="pun">:[</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="kwd">class</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[[</span><span class="pln">mockPhotoModel stub</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:</span><span class="pln">name</span><span class="pun">]</span><span class="pln"> photoName</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPPhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id mockViewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> partialMockForObject</span><span class="pun">:</span><span class="pln">viewModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[[</span><span class="pln">mockViewModel stub</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:</span><span class="pln">mockPhotoModel</span><span class="pun">]</span><span class="pln"> model</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id returnedName </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">mockViewModel photoName</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    expect</span><span class="pun">(</span><span class="pln">returnedName</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">name</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="pln">mockPhotoModel stopMocking</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it </span><span class="pun">(@</span><span class="str">"should correctly map image data to UIImage"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">UIImage</span><span class="pln"> </span><span class="pun">*</span><span class="pln">image </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">UIImage</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">imageData </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSData</span><span class="pln"> data</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    id mockImage </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">OCMockObject</span><span class="pln"> mockForClass</span><span class="pun">:[</span><span class="typ">UIImage</span><span class="pln"> </span><span class="kwd">class</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[[[</span><span class="pln">mockImage stub</span><span class="pun">]</span><span class="pln"> andReturn</span><span class="pun">:</span><span class="pln">image</span><span class="pun">]</span><span class="pln"> imageWithData</span><span class="pun">:</span><span class="pln">imageData</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    photoModel</span><span class="pun">.</span><span class="pln">fullsizedData </span><span class="pun">=</span><span class="pln"> imageData</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    __unused </span><span class="typ">FRPPhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="pln">mockImage verify</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="pln">mockImage stopMocking</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">it</span><span class="pun">(@</span><span class="str">"should return the correct photo name"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*</span><span class="pln">name </span><span class="pun">=</span><span class="pln"> </span><span class="pun">@</span><span class="str">"Ash"</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> init</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    photoModel</span><span class="pun">.</span><span class="pln">photoName </span><span class="pun">=</span><span class="pln"> name</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">FRPPhotoViewModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewModel </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPPhotoViewModel</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*</span><span class="pln">returnedName </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">viewModel photoName</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    expect</span><span class="pun">(</span><span class="pln">name</span><span class="pun">).</span><span class="pln">to</span><span class="pun">.</span><span class="pln">equal</span><span class="pun">(</span><span class="pln">returnedName</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">});</span></code></li>
</ol></pre>
<p class="calibre15">&#160;&#160;这就是为视图模型撰写单元测试的全部内容了。</p>
<p class="calibre15">&#160;&#160;在理想的情况下，单元测试能帮助改进你的代码质量。小巧而高内聚的方法比随意的满是副作用的方法更招人待见。它简单而完美地诠释了函数响应型编程的精髓。</p>
<p class="calibre15">&#160;&#160;测试MVVM的好处是：我们不用触及UIKit。请记住，写得好的MVVM视图模型的特点是：该视图模型不会与用户交互的接口类有任何交互。</p>

    </div>
</body>
</html>