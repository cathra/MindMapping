<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>iOS的函数响应型编程 - 书栈(BookStack.CN)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../Styles/stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../Styles/page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre6">
    <h1 id="article-title" class="calibre11">和FunctionalReactivePixels一起实践</h1>
    <div class="article-body" id="page-content">
        <div class="markdown-toc"><ul class="markdown-toc-list"><li class="calibre12"><a class="pcalibre1 calibre9 pcalibre" href="#和FunctionalReactivePixels一起实践" level="1">和FunctionalReactivePixels一起实践</a><ul class="calibre13"></ul></li>
</ul>
</div>
<h1 id="h1--functionalreactivepixels-" class="calibre14"><a class="pcalibre1 calibre9 pcalibre" id="和FunctionalReactivePixels一起实践"></a><span class="pcalibre2 header-link"></span>和FunctionalReactivePixels一起实践</h1>
<p class="calibre15">上一节，我们很多次使用了<code class="calibre20 pcalibre6 pcalibre5">ReactiveCocoa</code>的关键部分，这里有更多的机会来使用<code class="calibre20 pcalibre6 pcalibre5">ReactiveCocoa</code>整个代码库。开始吧！</p>
<p class="calibre15">首先在我们的画廊视图控制器中实现三个不同的代理方法：<code class="calibre20 pcalibre6 pcalibre5">CollectionViewDataSource</code>、<code class="calibre20 pcalibre6 pcalibre5">CollectionViewDelegate</code>、高清图视图控制器的<code class="calibre20 pcalibre6 pcalibre5">PhotoViewControllerDelegate</code></p>
<p class="calibre15">使用一个称之为<code class="calibre20 pcalibre6 pcalibre5">RACDelegateProxy</code>的实例，我们可以抽象委托类型的协议的任何方法实现(比如：那些返回void类型的)。</p>
<p class="calibre15">委托代理是一个称为<code class="calibre20 pcalibre6 pcalibre5">rac_signalForSelector:</code>对象的‘白板’，获取当Selector被调用时发送的新值的信号。</p>
<p class="calibre15">注意：你必须retain这个delegate对象，否则他们将会被释放，你将会得到一个<code class="calibre20 pcalibre6 pcalibre5">EXC_BAD_ACCESS</code>异常。添加下列私有属性到画廊视图控制器：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> strong</span><span class="pun">)</span><span class="pln"> id collectionViewDelegate</span><span class="pun">;</span></code></li>
</ol></pre>
<p class="calibre15">同时你也需要导入<code class="calibre20 pcalibre6 pcalibre5">RACDelegateProxy.h</code>，因为他不是ReactiveCocoa的核心部分，不包含在<code class="calibre20 pcalibre6 pcalibre5">ReactiveCocoa.h</code>中。移除<code class="calibre20 pcalibre6 pcalibre5">UICollectionViewDelegate</code>以及<code class="calibre20 pcalibre6 pcalibre5">FRPFullsizePhotoViewControllerDelegate</code>方法，追加下面的代码到<code class="calibre20 pcalibre6 pcalibre5">viewDidLoad</code>.</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">RACDelegateProxy</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewControllerDelegate </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">RACDelegateProxy</span><span class="pln"> alloc</span><span class="pun">]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    initWithProtocol</span><span class="pun">:</span><span class="lit">@protocol</span><span class="pun">(</span><span class="typ">FRPFullSizePhotoViewControllerDelegate</span><span class="pun">)];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">[[</span><span class="pln">viewControllerDelegate rac_signalForSelector</span><span class="pun">:</span><span class="lit">@selector</span><span class="pun">(</span><span class="pln">userDidScroll</span><span class="pun">:</span><span class="pln">toPhotoAtIndex</span><span class="pun">:)</span><span class="pln">     fromProtocol</span><span class="pun">:</span><span class="lit">@protocol</span><span class="pun">(</span><span class="typ">FRPFullSizePhotoViewControllerDelegate</span><span class="pun">)]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        subscribeNext</span><span class="pun">:^(</span><span class="typ">RACTuple</span><span class="pln"> </span><span class="pun">*</span><span class="pln">value</span><span class="pun">){</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="lit">@strongify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">collectionView</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                scrollToItemAtIndexPath</span><span class="pun">:[</span><span class="typ">NSIndexPath</span><span class="pln"> indexPathForItem</span><span class="pun">:[</span><span class="pln">value</span><span class="pun">.</span><span class="pln">second integerValue</span><span class="pun">]</span><span class="pln"> inSection</span><span class="pun">:</span><span class="lit">0</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                atScrollPosition</span><span class="pun">:</span><span class="typ">UICollectionViewScrollPositionCenteredVertically</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                animated</span><span class="pun">:</span><span class="pln">NO</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="kwd">self</span><span class="pun">.</span><span class="pln">collectionViewDelegate </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">RACDelegateProxy</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithProtocol</span><span class="pun">:</span><span class="lit">@protocol</span><span class="pun">(</span><span class="typ">UICollectionViewDelegate</span><span class="pun">)];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">[[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">collectionViewDelegate rac_signalForSelector</span><span class="pun">:</span><span class="lit">@selector</span><span class="pun">(</span><span class="pln">collectionView</span><span class="pun">:</span><span class="pln">didSelectItemAtIndexPath</span><span class="pun">:)]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        subscribeNext</span><span class="pun">:^(</span><span class="typ">RACTuple</span><span class="pln"> </span><span class="pun">*</span><span class="pln">arguments</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="lit">@strongify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> </span><span class="pun">*</span><span class="pln">viewController </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">FRPFullSizePhotoViewController</span><span class="pln"> alloc</span><span class="pun">]</span><span class="pln"> initWithPhotoModels</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">photosArray currentPhotoIndex</span><span class="pun">:[(</span><span class="typ">NSIndexPath</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">arguments</span><span class="pun">.</span><span class="pln">second item</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            viewController</span><span class="pun">.</span><span class="kwd">delegate</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="pln">id</span><span class="pun">&lt;</span><span class="typ">FRPFullSizePhotoViewControllerDelegate</span><span class="pun">&gt;)</span><span class="pln">viewControllerDelegate</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">navigationController pushViewController</span><span class="pun">:</span><span class="pln">viewController animated</span><span class="pun">:</span><span class="pln">YES</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}];</span></code></li>
</ol></pre>
<p class="calibre15">我们也可以在<code class="calibre20 pcalibre6 pcalibre5">self</code>上调用<code class="calibre20 pcalibre6 pcalibre5">rac_signalForSelector:</code>，使用同样的block块。然而，我们有必要在视图控制器实现里提供一个空存根方法以避免编译器发出”实现不完全”之类的警告。</p>
<blockquote class="calibre16">
<p class="calibre15">空存根方法：源于C++的一个非常不错的函数设计方法。在设计整个程序时，一般会先编写完所有的代码，然后开始编译和测试，但这样有时候会出现一大堆错误而不知从哪里入手，这时我们可以采用空存根技术。</p>
<p class="calibre15">存根是一个仅仅返回某个意义不大的值的空函数。存根可以用来测试整个程序的逻辑关系，以及分块实现程序的不同部分。</p>
<p class="calibre17">设计一个程序时，先分析设计程序的各个函数完成的功能；然后直接设计函数的存根并编译，编译通过，证明程序的逻辑关系没有问题的情况下，再来分别实现各个不同的函数(存根)。</p>
</blockquote>
<p class="calibre15">接下来，我们有更多的机会来抽象这个类中的方法。<code class="calibre20 pcalibre6 pcalibre5">loadPopularPhotos</code>方法除了改变我们的状态之外，并没有什么卵用。如果<code class="calibre20 pcalibre6 pcalibre5">ReactiveCocoa</code>能够很好地监控这些状态，让我们不在这方面担心的话，那肯定是极好的！幸运的是，我恰好知道这个~</p>
<p class="calibre15">我们移除这个方法，在viewDidLoad中键入下面的代码来代码这个方法的调用：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoSignal </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> importPhotos</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photosLoaded </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="pln">photoSignal </span><span class="kwd">catch</span><span class="pun">:^</span><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*(</span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSLog</span><span class="pun">(@</span><span class="str">"Couldn't fetch photos from 500px : %@"</span><span class="pun">,</span><span class="pln">error</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">RACSignal</span><span class="pln"> empty</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> photosArray</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> photosLoaded</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">[</span><span class="pln">photosLoaded subscribeCompleted</span><span class="pun">:</span><span class="pln"> </span><span class="pun">^{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="lit">@strongify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">conllectionView reloadData</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}];</span></code></li>
</ol></pre>
<p class="calibre15">一开始我们只是进行了<code class="calibre20 pcalibre6 pcalibre5">importPhotos</code>方法调用，不同的是，我们用<code class="calibre20 pcalibre6 pcalibre5">signal</code>来存放其返回值。<br class="calibre18"/>然后，我们“捕抓”这个信号上的错误并将它打印出来(跟我们之前做的一样，只不过语法不同而已)。比起<code class="calibre20 pcalibre6 pcalibre5">subscribeError:</code>方法，<code class="calibre20 pcalibre6 pcalibre5">catch:</code>方法处理的更为巧妙：它允许无错误值的信号穿透它，仅在信号有错误事件发生时才会调用它的block并发送其在发生错误时的返回值。这里我们使用<code class="calibre20 pcalibre6 pcalibre5">catch:</code>方法，来过滤无错误的值。这个<code class="calibre20 pcalibre6 pcalibre5">catch:</code>块仅仅返回一个空信号。更多关于这方面知识的细节<a href="http://stackoverflow.com/questions/19439636/difference-between-catch-and-subscribeerror" class="pcalibre1 calibre9 pcalibre">请参考StackOverFlow的问题</a>。</p>
<p class="calibre15">上面的方式，有一点点污染了我们的局部变量作用域，这可以用下面的更简洁的等效方法：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> photosArray</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[[[</span><span class="typ">FRPPhotoImporter</span><span class="pln"> importPhotos</span><span class="pun">]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        doCompleted</span><span class="pun">:^{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="lit">@strongify</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">);</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">collectionView reloadData</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="pun">}]</span><span class="pln"> logError</span><span class="pun">]</span><span class="pln"> catchTo</span><span class="pun">:[</span><span class="typ">RACSignal</span><span class="pln"> empty</span><span class="pun">]];</span></code></li>
</ol></pre>
<p class="calibre15">使用RAC宏，我们创建了<code class="calibre20 pcalibre6 pcalibre5">photosLoaded</code>信号的最新值到<code class="calibre20 pcalibre6 pcalibre5">photoArray</code>属性的单向绑定。太好了，保持状态!</p>
<p class="calibre15">我们来看一下，我们的collectionViewCell的子类实现：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@interface</span><span class="pln"> </span><span class="typ">FRPCell</span><span class="pln"> </span><span class="pun">()</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> weak</span><span class="pun">)</span><span class="pln"> </span><span class="typ">UIImageView</span><span class="pln"> </span><span class="pun">*</span><span class="pln">imageView</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> strong</span><span class="pun">)</span><span class="pln"> </span><span class="typ">RACDisposable</span><span class="pln"> </span><span class="pun">*</span><span class="pln">subscription</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@implementation</span><span class="pln"> </span><span class="typ">FRPCell</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="pln">instancetype</span><span class="pun">)</span><span class="pln">initWithFrame</span><span class="pun">:(</span><span class="typ">CGRect</span><span class="pun">)</span><span class="pln">frame </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">...</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">perpareForReuse </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">super</span><span class="pln"> perpareForReuse</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">subscription dispose</span><span class="pun">],</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">subscription </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">setPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">subscription </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[[</span><span class="typ">RACObserve</span><span class="pun">(</span><span class="pln">photoModel</span><span class="pun">,</span><span class="pln"> thumbnailData</span><span class="pun">)</span><span class="pln"> filter</span><span class="pun">:^</span><span class="pln">BOOL</span><span class="pun">(</span><span class="pln">id value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> value </span><span class="pun">!=</span><span class="pln"> </span><span class="kwd">nil</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}]</span><span class="pln"> map</span><span class="pun">:^</span><span class="pln">id</span><span class="pun">(</span><span class="pln">id value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIImage</span><span class="pln"> imageWithData</span><span class="pun">:</span><span class="pln">value</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}]</span><span class="pln"> setKeyPath</span><span class="pun">:</span><span class="lit">@keypath</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">imageView</span><span class="pun">,</span><span class="pln"> image</span><span class="pun">)</span><span class="pln"> onObject</span><span class="pun">:</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">imageView</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@end</span></code></li>
</ol></pre>
<p class="calibre15">这里有两个标志性的点表明了一个使用ReactiveCocoa来抽象的机会。</p>
<ol class="calibre24">
<li class="calibre12">我们有状态(<code class="calibre23 pcalibre6 pcalibre5">subscription</code>属性)</li>
<li class="calibre12">我们手动处理<code class="calibre23 pcalibre6 pcalibre5">RACDisposable</code>的生命周期</li>
</ol>
<p class="calibre15">无论何时调用一个<code class="calibre20 pcalibre6 pcalibre5">RACDisposable</code>对象的<code class="calibre20 pcalibre6 pcalibre5">dispose</code>方法，就是一个<strong class="calibre10">“这里有更加响应式的方法来作某件事”</strong>的好信号。在我们的例子中，这种嗅觉是对的。</p>
<p class="calibre15">通过在<code class="calibre20 pcalibre6 pcalibre5">FRPCell</code>创建一个新的属性，我们能够抽象掉使用<code class="calibre20 pcalibre6 pcalibre5">prepareForReuse</code>方法的必要性。这个属性就是<code class="calibre20 pcalibre6 pcalibre5">photoModel</code>(我们之前的行为就像是一个只写的属性，现在它将变为可读写的了)。把属性放在文件顶部：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="lit">@property</span><span class="pln"> </span><span class="pun">(</span><span class="pln">nonatomic</span><span class="pun">,</span><span class="pln"> strong </span><span class="pun">)</span><span class="pln"> </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoModel</span><span class="pun">;</span></code></li>
</ol></pre>
<p class="calibre15">下一步我们将彻底摆脱<code class="calibre20 pcalibre6 pcalibre5">setPhotoModel:</code>方法。我们将为<code class="calibre20 pcalibre6 pcalibre5">photoModel的thumbnailData</code>观察我们自己的关键路径。将下面的代码添加到cell的初始化函数中。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">RAC</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">imageView</span><span class="pun">,</span><span class="pln"> image</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[[</span><span class="typ">RACObserve</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> photoModel</span><span class="pun">.</span><span class="pln">thumbnailData</span><span class="pun">)</span><span class="pln"> ignore</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            map</span><span class="pun">:^(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">){</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="typ">UIImage</span><span class="pln"> imageWithData</span><span class="pun">:</span><span class="pln">data</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            </span><span class="pun">}];</span></code></li>
</ol></pre>
<p class="calibre15">注意看我们观察的是<code class="calibre20 pcalibre6 pcalibre5">self</code>的<code class="calibre20 pcalibre6 pcalibre5">photoModel.thumbnailData</code>的关键路径，而非<code class="calibre20 pcalibre6 pcalibre5">self.photoModel</code>的<code class="calibre20 pcalibre6 pcalibre5">thumbnailData</code>的关键路径。这点微妙的区别，作用却大大不同。当<code class="calibre20 pcalibre6 pcalibre5">self</code>的属性<code class="calibre20 pcalibre6 pcalibre5">photoModel</code>或者<code class="calibre20 pcalibre6 pcalibre5">photoModel</code>的<code class="calibre20 pcalibre6 pcalibre5">thumbnailData</code>属性改变时，关键路径<code class="calibre20 pcalibre6 pcalibre5">photoModel.thumbnailData</code>将会收到一个被(这种变化所)引发的KVO消息。</p>
<p class="calibre15">现在我们总算彻底摆脱了<code class="calibre20 pcalibre6 pcalibre5">subscription</code>属性！</p>

    </div>
</body>
</html>