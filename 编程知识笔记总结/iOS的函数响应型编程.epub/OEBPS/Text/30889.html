<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN" xml:lang="zh-CN">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>iOS的函数响应型编程 - 书栈(BookStack.CN)</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <link href="../Styles/stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="../Styles/page_styles.css" rel="stylesheet" type="text/css"/>
</head>
  <body class="calibre6">
    <h1 id="article-title" class="calibre11">网络层回访</h1>
    <div class="article-body" id="page-content">
        <div class="markdown-toc"><ul class="markdown-toc-list"><li class="calibre12"><a class="pcalibre1 calibre9 pcalibre" href="#网络层回访" level="1">网络层回访</a><ul class="calibre13"></ul></li>
</ul>
</div>
<h1 id="h1-u7F51u7EDCu5C42u56DEu8BBF" class="calibre14"><a class="pcalibre1 calibre9 pcalibre" id="网络层回访"></a><span class="pcalibre2 header-link"></span>网络层回访</h1>
<p class="calibre15">还有一个机会来进一步接受我们函数反应型编程的理念，那就是我们的网络层 <code class="calibre20 pcalibre6 pcalibre5">FRPPhotoImporter</code>,我们先来看看下载图片的方法：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadThumbnailForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">thumbnailURL withCompletion</span><span class="pun">:^(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        photoModel</span><span class="pun">.</span><span class="pln">thumbnailData </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadFullsizedImageForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">fullsizedURL withCompletion</span><span class="pun">:^(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">        photoModel</span><span class="pun">.</span><span class="pln">fullsizedData </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">download</span><span class="pun">:(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">urlString withCompletion</span><span class="pun">:(</span><span class="kwd">void</span><span class="pln"> </span><span class="pun">(^)(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">))</span><span class="pln">completion </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">urlString</span><span class="pun">,</span><span class="pln"> </span><span class="pun">@</span><span class="str">"URL must not be nil"</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSURLRequest</span><span class="pln"> requestWithURL</span><span class="pun">:[</span><span class="pln">NSURL </span><span class="typ">URLWithString</span><span class="pun">:</span><span class="pln">urlString</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="typ">NSURLConnection</span><span class="pln"> sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                queue</span><span class="pun">:[</span><span class="typ">NSOperationQueue</span><span class="pln"> mainQueue</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                completionHandler</span><span class="pun">:</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                     </span><span class="pun">^(</span><span class="typ">NSURLResponse</span><span class="pln"> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">connectionError</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                            </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">completion</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                                completion</span><span class="pun">(</span><span class="pln">data</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                            </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                     </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">Completion blocks?这是另外一个使用Signals的机会。更深入一点来说，我们可以使用<code class="calibre20 pcalibre6 pcalibre5">NSURLConnection</code>的ReactiveCocoa的扩展。下面我们来重写上面的方法：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadThumbnailForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="pln">photoModel</span><span class="pun">,</span><span class="pln"> thumbnailData</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">thumbnailURL</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">void</span><span class="pun">)</span><span class="pln">downloadFullsizedImageForPhotoModel</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    RAC</span><span class="pun">(</span><span class="pln">photoModel</span><span class="pun">,</span><span class="pln">fullsizedData</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">fullsizedURL</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">download</span><span class="pun">:(</span><span class="typ">NSString</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">urlString </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSAssert</span><span class="pun">(</span><span class="pln">urlString </span><span class="pun">,</span><span class="pln"> </span><span class="pun">@</span><span class="str">"URL must not be nil"</span><span class="pun">);</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSURLRequest</span><span class="pln"> requestWithURL</span><span class="pun">:[</span><span class="pln">NSURL </span><span class="typ">URLWithString</span><span class="pun">:</span><span class="pln"> urlString</span><span class="pun">]];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[[[</span><span class="typ">NSURLConnection</span><span class="pln"> rac_sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="typ">RACTuple</span><span class="pln"> </span><span class="pun">*</span><span class="pln">value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="pln">value second</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">}]</span><span class="pln"> deliverOn</span><span class="pun">:[</span><span class="typ">RACScheduler</span><span class="pln"> mainThreadScheduler</span><span class="pun">]];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">这里有两个大的不同：</p>
<ol class="calibre24">
<li class="calibre12">我们使用RAC来绑定<code class="calibre23 pcalibre6 pcalibre5">downloadFullsizedImageForPhotoModel:</code>返回的信号的最新值。</li>
<li class="calibre12">我们返回<code class="calibre23 pcalibre6 pcalibre5">NSURLConnection的rac_sendAsynchronousRequest:</code>返回值的映射。</li>
</ol>
<p class="calibre15">我们来看看这里究竟发生了什么。<br class="calibre18"/>看文档：<code class="calibre20 pcalibre6 pcalibre5">rac_sendAsynchronousRequest:</code>返回一个发送网络请求响应值的信号。<code class="calibre20 pcalibre6 pcalibre5">RACTuple</code>它所发送的内容分别包含响应和数据。有网络错误发生时，它会抛出错误。 最后我们改变线程的调度，将signal切换到主线程上。 (一个线程的调度者类似于一个线程。)</p>
<p class="calibre15">看，网络信号将会把它的值返回给后台的调度者，如果我们不阻止它，它可能最终会去从事更新UI的事件，而后台线程是没有能力更新UI的。</p>
<p class="calibre15">我们回过头来看看最开始的那两行。注意下这行：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">RAC</span><span class="pun">(</span><span class="pln">photoModel</span><span class="pun">,</span><span class="pln"> thumbnailData</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> download</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">.</span><span class="pln">thumbnailURL</span><span class="pun">];</span></code></li>
</ol></pre>
<p class="calibre15">通常，我不推荐将一个model绑定到多个signal，然而，我们知道这个信号会在完成网络调用后立即执行完并结束订阅。只要我们仅在一个实例上绑定这个keyPath，这种就是安全的。</p>
<p class="calibre15">我们可以用类似的方式抽象掉使用<code class="calibre20 pcalibre6 pcalibre5">RACReplaySubject</code>的部分,来重新审视我们的<code class="calibre20 pcalibre6 pcalibre5">fetchPhotoDetails:</code>方法吧。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACReplaySubject</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">fetchPhotoDetails</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">RACReplaySubject</span><span class="pln"> </span><span class="pun">*</span><span class="pln">subject </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">RACReplaySubject</span><span class="pln"> subject</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> photoURLRequest</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">[</span><span class="typ">NSURLConnection</span><span class="pln"> sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                 queue</span><span class="pun">:[</span><span class="typ">NSOperationQueue</span><span class="pln"> mainQueue</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    completionHandler</span><span class="pun">:^(</span><span class="typ">NSURLResponse</span><span class="pln"> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSError</span><span class="pln"> </span><span class="pun">*</span><span class="pln">connectionError</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                id results </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSJSONSerialization</span><span class="pln"> </span><span class="typ">JSONObjectWithData</span><span class="pun">:</span><span class="pln">data options</span><span class="pun">:</span><span class="lit">0</span><span class="pln"> error</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">][@</span><span class="str">"photo"</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> configurePhotoModel</span><span class="pun">:</span><span class="pln">photoModel withDictionay</span><span class="pun">:</span><span class="pln">results</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> downloadFullsizedImageForPhotoModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="pln">subject sendNext</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="pln">subject sendCompleted</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">[</span><span class="pln">subject sendError</span><span class="pun">:</span><span class="pln">connectionError</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">            </span><span class="pun">}</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="pun">}];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> subject</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15">有一点点凌乱，我们来整理下。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">fetchPhotoDetails</span><span class="pun">:(</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">photoModel </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> photoURLRequest</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[[[[[[</span><span class="typ">NSURLConnection</span><span class="pln"> rac_sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request</span><span class="pun">]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                map</span><span class="pun">:^</span><span class="pln">id</span><span class="pun">(</span><span class="typ">RACTuple</span><span class="pln"> </span><span class="pun">*</span><span class="pln">value</span><span class="pun">){</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[</span><span class="pln">value second</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                </span><span class="pun">}]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                deliverOn</span><span class="pun">:[</span><span class="typ">RACScheduler</span><span class="pln"> mainThreadScheduler</span><span class="pun">]]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                        id results </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSJSONSerialization</span><span class="pln"> </span><span class="typ">JSONObjectWithData</span><span class="pun">:</span><span class="pln">data</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                                                       options</span><span class="pun">:</span><span class="lit">0</span><span class="pln"> error</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">][@</span><span class="str">"photo"</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                        </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> configurePhotoModel</span><span class="pun">:</span><span class="pln">photoModel withDictionary</span><span class="pun">:</span><span class="pln">results</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                        </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> downloadFullsizedImageForPhotoModel</span><span class="pun">:</span><span class="pln">photoModel</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                        </span><span class="kwd">return</span><span class="pln"> photoModel</span><span class="pun">;</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                                    </span><span class="pun">}]</span><span class="pln"> publish</span><span class="pun">]</span><span class="pln"> autoconnect</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
<p class="calibre15"><strong class="calibre10">注意：</strong> 返回值从<code class="calibre20 pcalibre6 pcalibre5">RACReplaySubject *</code>变成了<code class="calibre20 pcalibre6 pcalibre5">RACSignal *</code>.<br class="calibre18"/>这里有很多地方需要梳理，所以我们提前做了下面这个示意图来说明：</p>
<p class="calibre15"><img src="../Images/741ca44e9fa9597609eb1b789d9b880b.png" alt="RACSignal_Process_Diagram" class="calibre22"/></p>
<p class="calibre15">我们已经知道<code class="calibre20 pcalibre6 pcalibre5">deliverOn:</code>是怎样工作的，所以让我们来关注信号链条最末端的信号操作<code class="calibre20 pcalibre6 pcalibre5">publish</code>. <code class="calibre20 pcalibre6 pcalibre5">publish</code>返回一个<code class="calibre20 pcalibre6 pcalibre5">RACMulitcastConnection</code>,当信号连接上时，他将订阅该接收信号。<code class="calibre20 pcalibre6 pcalibre5">autoconnect</code>为我们做的是：当它返回的信号被订阅，连接到<br class="calibre18"/> 该(订阅背后的)信号（underly signal）。</p>
<p class="calibre15"> 执行获取每一个订阅，在订阅的时候，我们返回的信号将会变“冷”。那是因为我们对底层信号进行多播，网络请求只会执行一次，但是它的结果被多播。这会导致：网络信号将只会被执行一次（当它被订阅时执行），是冷的(直到订阅为止，它不会被执行)，甚至可删除的(如果一次性处理订阅的生成)。</p>
<p class="calibre15">基本上，我们能保证信号只会被订阅一次，我们不需要回滚(replay).</p>
<p class="calibre15">注意：我们可以用下面的<code class="calibre20 pcalibre6 pcalibre5">reduceEach:</code>替代使用<code class="calibre20 pcalibre6 pcalibre5">RACTuple</code>的第一个<code class="calibre20 pcalibre6 pcalibre5">map:</code>，以便提供编译时检查。</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">reduceEach</span><span class="pun">:^</span><span class="pln">id</span><span class="pun">(</span><span class="typ">NSURLResponse</span><span class="pln"> </span><span class="pun">*</span><span class="pln">response</span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}]</span></code></li>
</ol></pre>
<p class="calibre15">剩下的网络访问接口，<code class="calibre20 pcalibre6 pcalibre5">importPhotos</code>方法重构如下：</p>
<pre class="prettyprint"><ol class="linenums"><li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="typ">RACSignal</span><span class="pln"> </span><span class="pun">*)</span><span class="pln">importPhotos </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="typ">NSURLRequest</span><span class="pln"> </span><span class="pun">*</span><span class="pln">request </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> popularURLRequest</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[[[[[[</span><span class="typ">NSURLConnection</span><span class="pln"> rac_sendAsynchronousRequest</span><span class="pun">:</span><span class="pln">request</span><span class="pun">]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                reduceEach</span><span class="pun">:^</span><span class="pln">id</span><span class="pun">(</span><span class="typ">NSURLResponse</span><span class="pln"> </span><span class="pun">*</span><span class="pln">response </span><span class="pun">,</span><span class="pln"> </span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">){</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                    </span><span class="kwd">return</span><span class="pln"> data</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">}]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                deliverOn</span><span class="pun">:[</span><span class="typ">RACScheduler</span><span class="pln"> mainThreadScheduler</span><span class="pun">]]</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="typ">NSData</span><span class="pln"> </span><span class="pun">*</span><span class="pln">data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                    id results </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">NSJSONSerialization</span><span class="pln"> </span><span class="typ">JSONObjectWithData</span><span class="pun">:</span><span class="pln">data options</span><span class="pun">:</span><span class="lit">0</span><span class="pln"> error</span><span class="pun">:</span><span class="kwd">nil</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                    </span><span class="kwd">return</span><span class="pln"> </span><span class="pun">[[[</span><span class="pln">results</span><span class="pun">[@</span><span class="str">"photo"</span><span class="pun">]</span><span class="pln"> rac_sequence</span><span class="pun">]</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                        map</span><span class="pun">:^</span><span class="pln">id </span><span class="pun">(</span><span class="typ">NSDictionary</span><span class="pln"> </span><span class="pun">*</span><span class="pln">photoDictionary</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            </span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="pun">*</span><span class="pln">model </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span><span class="typ">FRPPhotoModel</span><span class="pln"> </span><span class="kwd">new</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> configurePhotoModel</span><span class="pun">:</span><span class="pln">model withDictionary</span><span class="pun">:</span><span class="pln">photoDictionary</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            </span><span class="pun">[</span><span class="kwd">self</span><span class="pln"> downloadThumbnailForPhotoModel</span><span class="pun">:</span><span class="pln">model</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                            </span><span class="kwd">return</span><span class="pln"> model</span><span class="pun">;</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                        </span><span class="pun">}]</span><span class="pln"> array</span><span class="pun">];</span></code></li>
<li class="l1"><code class="pcalibre3 calibre19 pcalibre4"><span class="pln">                </span><span class="pun">}]</span><span class="pln"> publish</span><span class="pun">]</span><span class="pln"> autoconnect</span><span class="pun">];</span></code></li>
<li class="l"><code class="pcalibre3 calibre19 pcalibre4"><span class="pun">}</span></code></li>
</ol></pre>
    </div>
</body>
</html>